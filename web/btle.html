<!DOCTYPE html>
<html>

<head>
    <title>Bluetooth Connection</title>
</head>

<body>
    <button onclick="withConsoleErrors(connect)">Connect to BLE Device</button>
    <script>
        const UART_BT_SERVICE_ID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e"
        const TX_BT_CHAR_ID = "6e400002-b5a3-f393-e0a9-e50e24dcca9e"
        const RX_BT_CHAR_ID = "6e400003-b5a3-f393-e0a9-e50e24dcca9e"
        const ENC = new TextEncoder()
        const DEC = new TextDecoder()
        let rx, tx
        async function connect() {
            let device = await navigator.bluetooth.requestDevice({
                // acceptAllDevices: true, optionalServices: [UART_BT_SERVICE_ID]
                filters: [{ namePrefix: "NYUIMA" }], optionalServices: [UART_BT_SERVICE_ID]
            })
            console.info('device =', device);
            const server = await device.gatt.connect()
            console.info('server =', server)
            const service = await server.getPrimaryService(UART_BT_SERVICE_ID)
            console.info('service =', service)
            rx = await service.getCharacteristic(RX_BT_CHAR_ID)
            tx = await service.getCharacteristic(TX_BT_CHAR_ID)
            console.info('rx, tx =', rx, tx)
            await rx.startNotifications()
            rx.addEventListener('characteristicvaluechanged', ({ target }) => {
                const msg = DEC.decode(target.value.buffer)
                console.log('Rx', msg)
                if (msg == 'ping\n') {
                    transmit('pong\n')
                }
            })
        }
        function withConsoleErrors(fn) {
            return fn().catch(err =>
                console.error(err)
            )
        }
        function transmit(data) {
            tx.writeValue(ENC.encode(data));
        }
        function ping(data) {
            transmit('ping\n')
        }
    </script>
</body>

</html>
